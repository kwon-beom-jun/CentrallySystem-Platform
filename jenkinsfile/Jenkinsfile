pipeline {
    agent any
    
    tools {
        jdk 'JDK17'
        gradle 'Gradle-8'
        // Node.jsëŠ” ì‹œìŠ¤í…œì— ì„¤ì¹˜ëœ ê²ƒì„ ì‚¬ìš©
    }
    
    environment {
        GRADLE_USER_HOME = '/var/lib/jenkins/.gradle'
        ARTIFACTS_BASE_DIR = '/var/lib/jenkins/artifacts'
        NODE_OPTIONS = '--max-old-space-size=1024'  // t3.medium ë©”ëª¨ë¦¬ ìµœì í™”
        BUILD_ENV = 'prod'  // ë¹Œë“œ í™˜ê²½: 'prod' ë˜ëŠ” 'dev' (í”„ë¡ íŠ¸ì—”ë“œ .env íŒŒì¼ ì„ íƒìš©)
        
        // AP ì„œë²„ ë°°í¬ ì„¤ì •
        AP_SERVER = 'ubuntu@dummy_server_ip'  // AP ì„œë²„ ì£¼ì†Œ (ì‹¤ì œ IPë¡œ ìˆ˜ì • í•„ìš”)
        SSH_KEY = '/var/lib/jenkins/.ssh/deploy-key'
        AP_BASE_DIR = '/was/censys'
    }
    
    triggers {
        githubPush()
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10', artifactNumToKeepStr: '5'))
        timestamps()
        disableConcurrentBuilds()  // ë™ì‹œ ë¹Œë“œ ë°©ì§€ (ë©”ëª¨ë¦¬ ì ˆì•½)
    }
    
    stages {
        stage('ë³€ê²½ ê°ì§€') {
            steps {
                script {
                    echo "ğŸ” ë³€ê²½ëœ ì„œë¹„ìŠ¤ ê°ì§€ ì‹œì‘..."
                    
                    def changedServices = []
                    def coreChanged = false
                    def frontendChanged = false
                    
                    // ì„œë¹„ìŠ¤ ëª©ë¡ ìƒìˆ˜
                    def ALL_SERVICES = ['auth', 'hrm', 'gateway', 'info', 'receipt']
                    def ALL_SERVICES_STRING = 'auth,hrm,gateway,info,receipt'
                    def SERVICE_PREFIXES = [
                        'auth': 'centrally-system-auth',
                        'hrm': 'centrally-system-hrm',
                        'gateway': 'centrally-system-gateway',
                        'info': 'centrally-system-info',
                        'receipt': 'centrally-system-receipt'
                    ]
                    
                    // ì²« ë¹Œë“œì¸ ê²½ìš°
                    if (currentBuild.previousBuild == null) {
                        echo "âœ… ì²« ë¹Œë“œì…ë‹ˆë‹¤. ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤."
                        env.CHANGED_SERVICES = ALL_SERVICES_STRING
                        env.BUILD_FRONTEND = 'true'
                        return
                    }
                    
                    def previousCommit = currentBuild.previousBuild?.changeSets ? 
                        currentBuild.previousBuild.changeSets[0]?.items[0]?.commitId : 
                        env.GIT_PREVIOUS_COMMIT
                    
                    def currentCommit = env.GIT_COMMIT
                    
                    if (previousCommit == null || previousCommit == currentCommit) {
                        echo "------------------------------------------------------------"
                        echo "â­ï¸ ì´ì „ ì»¤ë°‹ ì •ë³´ê°€ ì—†ê±°ë‚˜ ë™ì¼í•©ë‹ˆë‹¤. ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤."
                        echo "------------------------------------------------------------"
                        env.CHANGED_SERVICES = ALL_SERVICES_STRING
                        env.BUILD_FRONTEND = 'true'
                        return
                    }
                    
                    // ë³€ê²½ëœ íŒŒì¼ í™•ì¸ (ë¹ˆ ë¬¸ìì—´ í•„í„°ë§)
                    def changesOutput = sh(
                        script: "git diff --name-only ${previousCommit} ${currentCommit}",
                        returnStdout: true
                    ).trim()
                    
                    def changes = changesOutput ? changesOutput.split('\n').findAll { it.trim() } : []
                    
                    echo "------------------------------------------------------------"
                    echo "ğŸ“„ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ (${changes.size()}ê°œ):"
                    if (changes.isEmpty()) {
                        echo "  (ë³€ê²½ëœ íŒŒì¼ ì—†ìŒ)"
                    } else {
                        changes.each { file ->
                            def trimmedFile = file.trim()
                            echo "  - ${trimmedFile}"
                            
                            // ì„œë¹„ìŠ¤ ë§¤í•‘ (Map ê¸°ë°˜)
                            SERVICE_PREFIXES.each { serviceName, prefix ->
                                if (trimmedFile.startsWith("${prefix}/")) {
                                    changedServices << serviceName
                                }
                            }
                            
                            // í”„ë¡ íŠ¸ì—”ë“œ ë° ì½”ì–´ ì²´í¬
                            if (trimmedFile.startsWith('centrally-web-vue3-vite/')) {
                                frontendChanged = true
                            } else if (trimmedFile.startsWith('centrally-system-core/')) {
                                coreChanged = true
                            } else if (trimmedFile.startsWith('jenkinsfile/')) {
                                coreChanged = true
                            }
                        }
                    }
                    echo "------------------------------------------------------------"
                    
                    // core ë˜ëŠ” jenkinsfile ë³€ê²½ ì‹œ ëª¨ë“  ì„œë¹„ìŠ¤ ë¹Œë“œ
                    if (coreChanged) {
                        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                        echo "âœ… centrally-system-core ë˜ëŠ” jenkinsfile ë³€ê²½ ê°ì§€"
                        echo "ğŸ“¦ ë¹Œë“œ ëŒ€ìƒ: ëª¨ë“  ì„œë¹„ìŠ¤"
                        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                        env.CHANGED_SERVICES = ALL_SERVICES_STRING
                        env.BUILD_FRONTEND = 'true'
                    } else {
                        changedServices = changedServices.unique()
                        
                        if (changedServices.isEmpty() && !frontendChanged) {
                            echo "â­ï¸ ë³€ê²½ëœ ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. ë¹Œë“œë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
                            currentBuild.result = 'NOT_BUILT'
                            error("No changes detected in any service")
                        } else {
                            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                            if (!changedServices.isEmpty()) {
                                env.CHANGED_SERVICES = changedServices.join(',')
                                echo "âœ… ë³€ê²½ëœ ë°±ì—”ë“œ ì„œë¹„ìŠ¤: ${changedServices.join(', ')}"
                            }
                            if (frontendChanged) {
                                env.BUILD_FRONTEND = 'true'
                                echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ë³€ê²½ ê°ì§€"
                            }
                            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                        }
                    }
                }
            }
        }
        
        stage('í™˜ê²½ í™•ì¸') {
            steps {
                echo "ğŸ“‹ ë¹Œë“œ í™˜ê²½ í™•ì¸ ì¤‘..."
                sh '''
                    echo "===== Java Version ====="
                    java -version
                    echo ""
                    echo "===== Gradle Version ====="
                    gradle -v
                    echo ""
                    echo "===== Node.js Version ====="
                    node -v
                    echo ""
                    echo "===== npm Version ====="
                    npm -v
                    echo ""
                    echo "===== Git Commit ====="
                    echo "Current Commit: ${GIT_COMMIT}"
                    echo ""
                    echo "===== ë¹Œë“œ í™˜ê²½ ====="
                    echo "Environment: ${BUILD_ENV}"
                    echo ""
                    echo "===== ë¹Œë“œ ëŒ€ìƒ ì„œë¹„ìŠ¤ ====="
                    echo "Backend: ${CHANGED_SERVICES}"
                    echo "Frontend: ${BUILD_FRONTEND}"
                '''
            }
        }
        
        stage('CORE ë¹Œë“œ') {
            steps {
                script {
                    if (env.CHANGED_SERVICES != null && env.CHANGED_SERVICES != '') {
                        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                        echo "ğŸ“¦ centrally-system-core ìš°ì„  ë¹Œë“œ"
                        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                        
                        dir('centrally-system-core') {
                            sh '''
                                chmod +x gradlew
                                ./gradlew clean build -x test --no-daemon
                                echo "âœ… Core ë¹Œë“œ ì™„ë£Œ (Gradle ìºì‹œì— ì €ì¥ë¨)"
                            '''
                        }
                        
                        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    } else {
                        echo "â­ï¸ ë³€ê²½ëœ ì„œë¹„ìŠ¤ê°€ ì—†ì–´ CORE ë¹Œë“œë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
                    }
                }
            }
        }
        
        stage('í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ') {
            steps {
                script {
                    if (env.BUILD_FRONTEND == 'true') {
                        buildFrontend()
                    } else {
                        echo "â­ï¸ í”„ë¡ íŠ¸ì—”ë“œ ë³€ê²½ì´ ì—†ì–´ ë¹Œë“œë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
                    }
                }
            }
        }
        
        stage('ì„œë¹„ìŠ¤ ë¹Œë“œ') {
            steps {
                script {
                    def ALL_SERVICES = ['auth', 'hrm', 'gateway', 'info', 'receipt']
                    def changedServicesList = []
                    
                    if (env.CHANGED_SERVICES != null && env.CHANGED_SERVICES != '') {
                        changedServicesList = env.CHANGED_SERVICES.split(',').collect { it.trim() }
                    }
                    
                    echo "ğŸš€ ë³€ê²½ëœ ì„œë¹„ìŠ¤: ${changedServicesList.isEmpty() ? 'ì—†ìŒ' : changedServicesList.join(', ')}"
                    echo "âš™ï¸ t3.medium ìµœì í™”: 2ê°œì”© ìˆœì°¨ì  ë³‘ë ¬ ë¹Œë“œ"
                    
                    // t3.medium ìµœì í™”: 2ê°œì”© ë°°ì¹˜ë¡œ ë‚˜ëˆ„ì–´ ìˆœì°¨ ì‹¤í–‰
                    def batchSize = 2
                    def batches = ALL_SERVICES.collate(batchSize)
                    
                    batches.eachWithIndex { batch, batchIndex ->
                        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                        echo "ğŸ“¦ ë°°ì¹˜ ${batchIndex + 1}/${batches.size()}: ${batch.join(', ')}"
                        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                        
                        def parallelStages = [:]
                        batch.each { serviceName ->
                            parallelStages["${serviceName.toUpperCase()} ë¹Œë“œ"] = {
                                stage("${serviceName.toUpperCase()} ë¹Œë“œ") {
                                    if (shouldBuildService(serviceName)) {
                                        buildService(serviceName)
                                    } else {
                                        echo "â­ï¸ ${serviceName.toUpperCase()} ì„œë¹„ìŠ¤ ë³€ê²½ ì—†ìŒ - ê±´ë„ˆëœ€"
                                    }
                                }
                            }
                        }
                        
                        // í•´ë‹¹ ë°°ì¹˜ ë‚´ì—ì„œëŠ” ë³‘ë ¬ ì‹¤í–‰
                        parallel parallelStages
                        
                        // ë°°ì¹˜ ê°„ ì§§ì€ ëŒ€ê¸° (ë©”ëª¨ë¦¬ ì •ë¦¬)
                        if (batchIndex < batches.size() - 1) {
                            echo "â¸ï¸ ë‹¤ìŒ ë°°ì¹˜ ì „ ë©”ëª¨ë¦¬ ì •ë¦¬ ëŒ€ê¸° (5ì´ˆ)..."
                            sleep 5
                        }
                    }
                    
                    echo "âœ… ëª¨ë“  ë°°ì¹˜ ë¹Œë“œ ì™„ë£Œ!"
                }
            }
        }
        
        stage('ë°±ì—”ë“œ ë°°í¬') {
            steps {
                script {
                    if (env.CHANGED_SERVICES != null && env.CHANGED_SERVICES != '') {
                        def services = env.CHANGED_SERVICES.split(',').collect { it.trim() }
                        
                        echo "------------------------------------------------------------"
                        echo "ğŸ“¦ ë°±ì—”ë“œ ë°°í¬ ì‹œì‘"
                        echo "ëŒ€ìƒ ì„œë¹„ìŠ¤: ${services.join(', ')}"
                        echo "âš¡ ëª¨ë“  ì„œë¹„ìŠ¤ ë³‘ë ¬ ë°°í¬"
                        echo "------------------------------------------------------------"
                        
                        // ëª¨ë“  ì„œë¹„ìŠ¤ ë³‘ë ¬ ë°°í¬
                        def parallelDeploys = [:]
                        services.each { serviceName ->
                            parallelDeploys[serviceName] = {
                                deployService(serviceName)
                            }
                        }
                        
                        // ë³‘ë ¬ ì‹¤í–‰
                        parallel parallelDeploys
                        
                        echo "------------------------------------------------------------"
                        echo "âœ… ë°±ì—”ë“œ ë°°í¬ ì™„ë£Œ"
                        echo "------------------------------------------------------------"
                    } else {
                        echo "â­ï¸ ë³€ê²½ëœ ì„œë¹„ìŠ¤ê°€ ì—†ì–´ ë°±ì—”ë“œ ë°°í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
                    }
                }
            }
        }
        
        stage('í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬') {
            steps {
                script {
                    if (env.BUILD_FRONTEND == 'true') {
                        echo "------------------------------------------------------------"
                        echo "ğŸ¨ í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì‹œì‘"
                        echo "------------------------------------------------------------"
                        
                        try {
                            // 1. dist.tar.gz ì „ì†¡
                            sh """
                                scp -i ${SSH_KEY} -o StrictHostKeyChecking=no \
                                    ${ARTIFACTS_BASE_DIR}/frontend/frontend-latest.tar.gz \
                                    ${AP_SERVER}:/tmp/frontend-latest.tar.gz
                            """
                            
                            // 2. ë°±ì—… ë° ì••ì¶• í•´ì œ
                            sh """
                                ssh -i ${SSH_KEY} -o StrictHostKeyChecking=no ${AP_SERVER} '
                                    # ê¸°ì¡´ dist ë°±ì—…
                                    if [ -d ${AP_BASE_DIR}/dist ]; then
                                        sudo mv ${AP_BASE_DIR}/dist ${AP_BASE_DIR}/dist.backup.\$(date +%Y%m%d-%H%M%S)
                                    fi
                                    
                                    # ìƒˆ dist ë””ë ‰í† ë¦¬ ìƒì„±
                                    mkdir -p ${AP_BASE_DIR}/dist
                                    
                                    # dist ì•ˆì˜ ì½˜í…ì¸ ë§Œ dist í´ë”ì— ì••ì¶• í•´ì œ
                                    tar -xzf /tmp/frontend-latest.tar.gz -C ${AP_BASE_DIR}/dist --strip-components=1
                                    
                                    # ì„ì‹œ íŒŒì¼ ì‚­ì œ
                                    rm /tmp/frontend-latest.tar.gz
                                    
                                    # Nginx ì¬ë¡œë“œ
                                    sudo systemctl reload nginx
                                    
                                    echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì™„ë£Œ"
                                '
                            """
                            
                            echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì™„ë£Œ"
                            
                        } catch (Exception e) {
                            echo "âŒ í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì‹¤íŒ¨: ${e.message}"
                            currentBuild.result = 'FAILURE'
                            error("í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì‹¤íŒ¨")
                        }
                        
                        echo "------------------------------------------------------------"
                    } else {
                        echo "â­ï¸ í”„ë¡ íŠ¸ì—”ë“œ ë³€ê²½ì´ ì—†ì–´ ë°°í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
                    }
                }
            }
        }
    }
    
    post {
        success {
            script {
                def services = env.CHANGED_SERVICES?.split(',')?.collect { it.trim() }?.join(', ') ?: 'ì—†ìŒ'
                def frontend = env.BUILD_FRONTEND == 'true' ? 'Vue Frontend' : 'ì—†ìŒ'
                echo "âœ… ë¹Œë“œ ë° ë°°í¬ ì„±ê³µ!"
                echo "ğŸ“¦ ë°°í¬ëœ ë°±ì—”ë“œ: ${services}"
                echo "ğŸ¨ ë°°í¬ëœ í”„ë¡ íŠ¸ì—”ë“œ: ${frontend}"
            }
        }
        failure {
            echo "âŒ ë¹Œë“œ ë˜ëŠ” ë°°í¬ ì‹¤íŒ¨!"
        }
        always {
            echo "ğŸ§¹ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì •ë¦¬ ì¤‘..."
            cleanWs(
                deleteDirs: true,
                patterns: [
                    [pattern: '**/build/', type: 'INCLUDE'],
                    [pattern: '**/node_modules/', type: 'INCLUDE']
                ]
            )
        }
    }
}

/**
 * ì„œë¹„ìŠ¤ ë¹Œë“œ ì—¬ë¶€ í™•ì¸ í•¨ìˆ˜
 */
def shouldBuildService(String serviceName) {
    if (env.CHANGED_SERVICES == null || env.CHANGED_SERVICES == '') {
        return false
    }
    def services = env.CHANGED_SERVICES.split(',').collect { it.trim() }
    return services.contains(serviceName)
}

/**
 * ì„œë¹„ìŠ¤ ë°°í¬ í•¨ìˆ˜ (ê³µí†µ)
 */
def deployService(String serviceName) {
    try {
        echo "ğŸš€ ${serviceName} ë°°í¬ ì¤‘..."
        
        // 1. JAR íŒŒì¼ ì „ì†¡
        sh """
            scp -i ${SSH_KEY} -o StrictHostKeyChecking=no \
                ${ARTIFACTS_BASE_DIR}/${serviceName}/${serviceName}-latest.jar \
                ${AP_SERVER}:${AP_BASE_DIR}/${serviceName}.jar
        """
        
        // 2. ì¬ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        sh """
            ssh -i ${SSH_KEY} -o StrictHostKeyChecking=no ${AP_SERVER} \
                'bash ${AP_BASE_DIR}/deploy-service.sh ${serviceName}'
        """
        
        echo "âœ… ${serviceName} ë°°í¬ ì™„ë£Œ"
        
    } catch (Exception e) {
        echo "âŒ ${serviceName} ë°°í¬ ì‹¤íŒ¨: ${e.message}"
        currentBuild.result = 'FAILURE'
        error("${serviceName} ë°°í¬ ì‹¤íŒ¨")
    }
}

/**
 * ê°œë³„ ì„œë¹„ìŠ¤ ë¹Œë“œ í•¨ìˆ˜
 */
def buildService(String serviceName) {
    def serviceDir = "centrally-system-${serviceName}"
    def artifactDir = "${ARTIFACTS_BASE_DIR}/${serviceName}"
    def buildTimestamp = new Date().format('yyyyMMdd-HHmmss')
    
    try {
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ”¨ ${serviceName.toUpperCase()} ì„œë¹„ìŠ¤ ë¹Œë“œ ì‹œì‘"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        // ë¹Œë“œ ì¤€ë¹„
        dir(serviceDir) {
            echo "ğŸ§¹ ì´ì „ ë¹Œë“œ ì •ë¦¬ ì¤‘..."
            sh '''
                chmod +x gradlew
                ./gradlew clean
            '''
        }
        
        // ë¹Œë“œ
        dir(serviceDir) {
            echo "ğŸ”¨ ë¹Œë“œ ì‹œì‘..."
            sh '''
                chmod +x gradlew
                # t3.medium ìµœì í™”: ë©”ëª¨ë¦¬ ì œí•œ
                export GRADLE_OPTS="-Xmx768m -Xms256m -XX:MaxMetaspaceSize=384m -XX:+UseG1GC"
                ./gradlew build -x test --no-daemon --stacktrace
                echo ""
                echo "===== ë¹Œë“œ ê²°ê³¼ë¬¼ í™•ì¸ ====="
                ls -lh build/libs/
            '''
        }
        
        // í…ŒìŠ¤íŠ¸
        dir(serviceDir) {
            echo "ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
            sh '''
                chmod +x gradlew
                # í…ŒìŠ¤íŠ¸ìš© ë©”ëª¨ë¦¬ ì œí•œ
                export GRADLE_OPTS="-Xmx512m -Xms256m -XX:MaxMetaspaceSize=256m"
                ./gradlew test --no-daemon
            '''
            
            // JUnit í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìˆ˜ì§‘
            junit allowEmptyResults: true, testResults: "build/test-results/test/*.xml"
        }
        
        // ì•„í‹°íŒ©íŠ¸ ì €ì¥
        dir(serviceDir) {
            echo "ğŸ“¦ ë¹Œë“œ ê²°ê³¼ë¬¼ ì €ì¥ ì¤‘..."
            sh """
                mkdir -p ${artifactDir}
                
                # JAR íŒŒì¼ëª… í™•ì¸ (plain ì œì™¸)
                JAR_FILE=\$(ls build/libs/*.jar | grep -v plain | head -1)
                JAR_NAME=\$(basename \$JAR_FILE)
                
                # ë¹Œë“œ ë²ˆí˜¸ì™€ íƒ€ì„ìŠ¤íƒ¬í”„ í¬í•¨í•˜ì—¬ ë³µì‚¬
                cp \$JAR_FILE ${artifactDir}/${serviceName}-build-${BUILD_NUMBER}-${buildTimestamp}.jar
                
                # ìµœì‹  ë²„ì „ ì‹¬ë³¼ë¦­ ë§í¬
                ln -sf ${artifactDir}/${serviceName}-build-${BUILD_NUMBER}-${buildTimestamp}.jar \
                       ${artifactDir}/${serviceName}-latest.jar
                
                # ë¹Œë“œ ì •ë³´ ì €ì¥
                echo "BUILD_NUMBER: ${BUILD_NUMBER}" > ${artifactDir}/build-info-${BUILD_NUMBER}.txt
                echo "GIT_COMMIT: ${GIT_COMMIT}" >> ${artifactDir}/build-info-${BUILD_NUMBER}.txt
                echo "BUILD_TIMESTAMP: ${buildTimestamp}" >> ${artifactDir}/build-info-${BUILD_NUMBER}.txt
                echo "JAR_NAME: \$JAR_NAME" >> ${artifactDir}/build-info-${BUILD_NUMBER}.txt
                echo "SERVICE: ${serviceName}" >> ${artifactDir}/build-info-${BUILD_NUMBER}.txt
                echo "BUILD_URL: ${BUILD_URL}" >> ${artifactDir}/build-info-${BUILD_NUMBER}.txt
                
                echo ""
                echo "âœ… ì €ì¥ëœ ì•„í‹°íŒ©íŠ¸:"
                ls -lh ${artifactDir}/ | tail -5
            """
        }
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… ${serviceName.toUpperCase()} ì„œë¹„ìŠ¤ ë¹Œë“œ ì„±ê³µ!"
        echo "ğŸ“ ì•„í‹°íŒ©íŠ¸ ìœ„ì¹˜: ${artifactDir}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
    } catch (Exception e) {
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âŒ ${serviceName.toUpperCase()} ì„œë¹„ìŠ¤ ë¹Œë“œ ì‹¤íŒ¨!"
        echo "ì—ëŸ¬: ${e.message}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        throw e
    }
}

/**
 * í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ í•¨ìˆ˜
 */
def buildFrontend() {
    def frontendDir = 'centrally-web-vue3-vite'
    def artifactDir = "${ARTIFACTS_BASE_DIR}/frontend"
    def buildTimestamp = new Date().format('yyyyMMdd-HHmmss')
    
    try {
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ¨ Vue í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì‹œì‘"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        dir(frontendDir) {
            echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
            sh '''
                # node_modulesì™€ package-lock.json ì •ë¦¬ (rollup ë²„ê·¸ íšŒí”¼)
                rm -rf node_modules package-lock.json
                
                # npm installë¡œ ì¬ì„¤ì¹˜ (npm ci ëŒ€ì‹ )
                npm install --prefer-offline --no-audit
            '''
            
            echo "ğŸ”¨ í”„ë¡œë•ì…˜ ë¹Œë“œ ì‹œì‘ (.env.${BUILD_ENV} ì‚¬ìš©)..."
            sh """
                # BUILD_ENV í™˜ê²½ ë³€ìˆ˜ì— ë”°ë¼ .env.prod ë˜ëŠ” .env.dev ì‚¬ìš©
                echo "ë¹Œë“œ ëª¨ë“œ: ${BUILD_ENV}"
                npm run build -- --mode ${BUILD_ENV}
                
                echo ""
                echo "===== ë¹Œë“œ ê²°ê³¼ë¬¼ í™•ì¸ ====="
                ls -lh dist/
                du -sh dist/
            """
            
            echo "ğŸ“¦ ë¹Œë“œ ê²°ê³¼ë¬¼ ì €ì¥ ì¤‘..."
            sh """
                mkdir -p ${artifactDir}
                
                # dist ë””ë ‰í† ë¦¬ë¥¼ tar.gzë¡œ ì••ì¶•
                tar -czf ${artifactDir}/frontend-build-${BUILD_NUMBER}-${buildTimestamp}.tar.gz dist/
                
                # ìµœì‹  ë²„ì „ ì‹¬ë³¼ë¦­ ë§í¬
                ln -sf ${artifactDir}/frontend-build-${BUILD_NUMBER}-${buildTimestamp}.tar.gz \
                       ${artifactDir}/frontend-latest.tar.gz
                
                # ë¹Œë“œ ì •ë³´ ì €ì¥
                echo "BUILD_NUMBER: ${BUILD_NUMBER}" > ${artifactDir}/build-info-${BUILD_NUMBER}.txt
                echo "GIT_COMMIT: ${GIT_COMMIT}" >> ${artifactDir}/build-info-${BUILD_NUMBER}.txt
                echo "BUILD_TIMESTAMP: ${buildTimestamp}" >> ${artifactDir}/build-info-${BUILD_NUMBER}.txt
                echo "BUILD_MODE: ${BUILD_ENV}" >> ${artifactDir}/build-info-${BUILD_NUMBER}.txt
                echo "ENV_FILE: .env.${BUILD_ENV}" >> ${artifactDir}/build-info-${BUILD_NUMBER}.txt
                echo "BUILD_URL: ${BUILD_URL}" >> ${artifactDir}/build-info-${BUILD_NUMBER}.txt
                
                echo ""
                echo "âœ… ì €ì¥ëœ ì•„í‹°íŒ©íŠ¸:"
                ls -lh ${artifactDir}/ | tail -5
            """
        }
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… Vue í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì„±ê³µ!"
        echo "ğŸ“ ì•„í‹°íŒ©íŠ¸ ìœ„ì¹˜: ${artifactDir}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
    } catch (Exception e) {
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âŒ Vue í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì‹¤íŒ¨!"
        echo "ì—ëŸ¬: ${e.message}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        throw e
    }
}

