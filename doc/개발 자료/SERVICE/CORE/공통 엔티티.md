# ê³µí†µ ì—”í‹°í‹°

<br>

## ğŸ“‹ ê°œìš”

CORE ëª¨ë“ˆì€ í”„ë¡œì íŠ¸ ì „ë°˜ì—ì„œ ê³µí†µìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” ì—”í‹°í‹° í´ë˜ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ì´ë“¤ì€ JPAì˜ `@MappedSuperclass`ë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒì† ê¸°ë°˜ìœ¼ë¡œ ê³µí†µ í•„ë“œë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.

---

<br>

## ğŸ”§ ê³µí†µ ì—”í‹°í‹° ëª©ë¡

### 1. AuditTimeEntity

**ê²½ë¡œ:** `com.cs.core.entity.AuditTimeEntity`

**ì—­í• :** ëª¨ë“  ì—”í‹°í‹°ì˜ ê¸°ë³¸ ê³µí†µ í•„ë“œ(ë“±ë¡ì¼, ìˆ˜ì •ì¼, ë“±ë¡ì, ìˆ˜ì •ì)ë¥¼ ìë™ ê´€ë¦¬í•©ë‹ˆë‹¤.

**ì œê³µ í•„ë“œ:**

| í•„ë“œëª… | íƒ€ì… | ì„¤ëª… | ìë™ ì„¤ì • |
| --- | --- | --- | --- |
| `regTime` | `LocalDateTime` | ìƒì„± ì‹œê°„ | `@CreatedDate` |
| `updateTime` | `LocalDateTime` | ìˆ˜ì • ì‹œê°„ | `@LastModifiedDate` |
| `createdBy` | `String` | ìƒì„±ì | `@CreatedBy` |
| `modifiedBy` | `String` | ìˆ˜ì •ì | `@LastModifiedBy` |

**ì£¼ìš” íŠ¹ì§•:**

- **JPA Auditing ì ìš©**: `@EntityListeners(AuditingEntityListener.class)`ë¡œ ìë™ ê°ì‚¬ ê¸°ëŠ¥ í™œì„±í™”
- **ìë™ ê°’ ì„¤ì •**: 
  - `regTime`, `createdBy`: ì—”í‹°í‹° ìƒì„± ì‹œ ìë™ ì„¤ì • (ìˆ˜ì • ë¶ˆê°€)
  - `updateTime`, `modifiedBy`: ì—”í‹°í‹° ìˆ˜ì • ì‹œ ìë™ ì—…ë°ì´íŠ¸
- **ìƒì„±ì/ìˆ˜ì •ì ìë™ ì¶”ì¶œ**: `AuditorAwareImpl`ì„ í†µí•´ Spring Securityì˜ í˜„ì¬ ì‚¬ìš©ì ì •ë³´ë¥¼ ìë™ìœ¼ë¡œ ê°€ì ¸ì˜´

**ì‚¬ìš© ì˜ˆì‹œ:**

```java
@Entity
@Table(name = "auth_roles")
public class AuthRoles extends AuditTimeEntity {
    @Id
    private Integer roleId;
    private String roleName;
    // regTime, updateTime, createdBy, modifiedByëŠ” ë¶€ëª¨ í´ë˜ìŠ¤ì—ì„œ ìƒì†
}
```

**ì‚¬ìš©ë˜ëŠ” ì—”í‹°í‹° ì˜ˆì‹œ:**

- `AuthRoles`, `AuthUserRoles`, `AuthApplication`
- `HrmRoles`, `HrmPositions`, `HrmEmploymentType`
- `ReceiptClosings`
- `InfoPostAttachment`
- ê¸°íƒ€ ëŒ€ë¶€ë¶„ì˜ ì°¸ì¡° í…Œì´ë¸” ì—”í‹°í‹°

---

### 2. SoftDeleteEntity

**ê²½ë¡œ:** `com.cs.core.entity.SoftDeleteEntity`

**ì—­í• :** ë…¼ë¦¬ ì‚­ì œ(Soft Delete) ê¸°ëŠ¥ì„ ì œê³µí•˜ëŠ” ì—”í‹°í‹°ì…ë‹ˆë‹¤. `AuditTimeEntity`ë¥¼ ìƒì†ë°›ì•„ ê¸°ë³¸ ê°ì‚¬ í•„ë“œì™€ í•¨ê»˜ ì‚­ì œ ê´€ë ¨ í•„ë“œë¥¼ ì¶”ê°€ë¡œ ì œê³µí•©ë‹ˆë‹¤.

**ì œê³µ í•„ë“œ:**

| í•„ë“œëª… | íƒ€ì… | ì„¤ëª… | ê¸°ë³¸ê°’ |
| --- | --- | --- | --- |
| `enabled` | `Boolean` | í™œì„± ì—¬ë¶€ | `true` |
| `deletedAt` | `LocalDateTime` | ì‚­ì œ ì¼ì‹œ | `null` |

**ìƒì† í•„ë“œ:**

- `AuditTimeEntity`ì˜ ëª¨ë“  í•„ë“œ (`regTime`, `updateTime`, `createdBy`, `modifiedBy`)

**ì£¼ìš” íŠ¹ì§•:**

- **ë…¼ë¦¬ ì‚­ì œ ì§€ì›**: ì‹¤ì œ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì§€ ì•Šê³  `enabled = false`ë¡œ ë³€ê²½í•˜ì—¬ ë¹„í™œì„±í™”
- **Hibernate Filter ì ìš©**: 
  - `@FilterDef(name = "enabledFilter")`: í•„í„° ì •ì˜
  - `@Filter(name = "enabledFilter", condition = "enabled = :isEnabled")`: í™œì„±í™”ëœ ë°ì´í„°ë§Œ ì¡°íšŒ
- **ì‚­ì œ ì¼ì‹œ ê¸°ë¡**: `deletedAt` í•„ë“œì— ì‚­ì œ ì‹œì  ê¸°ë¡

**ì‚¬ìš© ì˜ˆì‹œ:**

```java
@Entity
@Table(name = "auth_users")
public class AuthUser extends SoftDeleteEntity {
    @Id
    private Integer userId;
    private String email;
    private String name;
    // regTime, updateTime, createdBy, modifiedBy, enabled, deletedAt ìƒì†
}

// ì‚­ì œ ì²˜ë¦¬
user.setEnabled(false);
user.setDeletedAt(LocalDateTime.now());
userRepository.save(user);
```

**ì‚¬ìš©ë˜ëŠ” ì—”í‹°í‹° ì˜ˆì‹œ:**

- `AuthUser` (ì‚¬ìš©ì)
- `HrmUser`, `HrmDepartments`, `HrmTeams` (ì¸ì‚¬ ê´€ë¦¬)
- `Receipt`, `ReceiptApprovalLine`, `ReceiptAttachments` (ì˜ìˆ˜ì¦)
- `InfoPost`, `InfoDepartments`, `InfoTeams` (ì •ë³´ ê´€ë¦¬)

---

### 3. AuditEntity

**ê²½ë¡œ:** `com.cs.core.entity.AuditEntity`

**í˜„ì¬ ìƒíƒœ:** ì£¼ì„ ì²˜ë¦¬ë˜ì–´ ì‚¬ìš©ë˜ì§€ ì•ŠìŒ

**ì„¤ëª…:** ì›ë˜ëŠ” `AuditTimeEntity`ë¥¼ ìƒì†ë°›ì•„ ë“±ë¡ì/ìˆ˜ì •ì í•„ë“œë¥¼ ì¶”ê°€ ì œê³µí•˜ë ¤ê³  í–ˆìœ¼ë‚˜, í˜„ì¬ëŠ” `AuditTimeEntity`ì— ì´ë¯¸ `createdBy`, `modifiedBy` í•„ë“œê°€ í¬í•¨ë˜ì–´ ìˆì–´ ë³„ë„ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

---

<br>

## ğŸ”„ ì—”í‹°í‹° ìƒì† êµ¬ì¡°

```
AuditTimeEntity (ê¸°ë³¸ ê°ì‚¬ í•„ë“œ)
    â”‚
    â”œâ”€ SoftDeleteEntity (ë…¼ë¦¬ ì‚­ì œ ì¶”ê°€)
    â”‚     â”‚
    â”‚     â””â”€ ì£¼ìš” ì—”í‹°í‹°ë“¤ (AuthUser, HrmUser, Receipt ë“±)
    â”‚
    â””â”€ ì°¸ì¡° í…Œì´ë¸” ì—”í‹°í‹°ë“¤ (AuthRoles, HrmRoles ë“±)
```

---

<br>

## ğŸ” ìë™ ê°ì‚¬ (JPA Auditing) ë™ì‘ ë°©ì‹

### AuditorAwareImpl

**ê²½ë¡œ:** `com.cs.core.config.AuditorAwareImpl`

**ì—­í• :** `@CreatedBy`, `@LastModifiedBy` í•„ë“œì— ìë™ìœ¼ë¡œ í˜„ì¬ ì‚¬ìš©ì ì •ë³´ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.

**ë™ì‘ ê³¼ì •:**

1. Spring Securityì˜ `SecurityContextHolder`ì—ì„œ í˜„ì¬ ì¸ì¦ ì •ë³´ ì¡°íšŒ
2. JWT ê¸°ë°˜ ì¸ì¦ì¸ ê²½ìš°: JWT í† í°ì˜ `sub` í´ë ˆì„ì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ
3. ì¼ë°˜ ì¸ì¦ì¸ ê²½ìš°: `Authentication.getName()` ì‚¬ìš©
4. ì¸ì¦ ì •ë³´ê°€ ì—†ìœ¼ë©´ ë¹ˆ ê°’ ë°˜í™˜

**ì„¤ì •:**

```java
@Configuration
@EnableJpaAuditing  // JPA Auditing í™œì„±í™”
public class AuditorAwareImpl implements AuditorAware<String> {
    // ...
}
```

---



<br>

## âš ï¸ ì£¼ì˜ì‚¬í•­

1. **Hibernate Filter í™œì„±í™” í•„ìš”**: `SoftDeleteEntity`ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°, Repository ì¡°íšŒ ì‹œ Hibernate Filterë¥¼ í™œì„±í™”í•´ì•¼ í•©ë‹ˆë‹¤.
   - ì¼ë°˜ì ìœ¼ë¡œ AOPë¥¼ í†µí•´ `@Transactional` ë²”ìœ„ì—ì„œ ìë™ìœ¼ë¡œ í•„í„°ê°€ í™œì„±í™”ë˜ë„ë¡ ì„¤ì •

2. **ìƒì„±ì/ìˆ˜ì •ì ìë™ ì„¤ì •**: 
   - ì¸ì¦ë˜ì§€ ì•Šì€ ìƒíƒœì—ì„œëŠ” `createdBy`, `modifiedBy`ê°€ `null`ë¡œ ì €ì¥ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
   - ë°°ì¹˜ ì‘ì—…ì´ë‚˜ ìŠ¤ì¼€ì¤„ëŸ¬ì—ì„œ ì—”í‹°í‹°ë¥¼ ìƒì„±/ìˆ˜ì •í•˜ëŠ” ê²½ìš° ìˆ˜ë™ìœ¼ë¡œ ì„¤ì •í•´ì•¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

3. **`regTime` ìˆ˜ì • ë¶ˆê°€**: `@Column(updatable = false)`ë¡œ ì„¤ì •ë˜ì–´ ìˆì–´ í•œ ë²ˆ ì €ì¥ëœ í›„ì—ëŠ” ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

4. **íŠ¸ëœì­ì…˜ ë²”ìœ„**: JPA Auditingì€ íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ë˜ëŠ” ì‹œì ì— ìë™ìœ¼ë¡œ `updateTime`ê³¼ `modifiedBy`ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.



<br><br>
