# 영수증 서비스 반려 프로세스

**DB 테이블**

- receipt 테이블 : `current_approval_step` , `last_rejection_date` ,
- receipt_approval_line 테이블 : `step_order` , `rejected_at` , `rejected_reason`

### **일반 결재(합의) 반려**

**메서드**: `ReceiptRequestService.saveReceiptDecisions`

- **영수증**
    - 상태 `REJECTED`(반려)로 변경
    - `current_approval_step`은 `null`로 변경되어 결재 흐름 중단
    - `last_rejection_date` 현재 날짜 기입
- **결재선**
    - **반려한 결재자 본인**의 라인에만 반려 시각(`rejected_at`) 및 반려 사유(`rejected_reason`) 기록
    - 다른 결재선은 변경되지 않음

### **내역 관리 강제 반려**

**메서드**: `ReceiptRequestService.forceChangeStatus`

- **영수증**
    - 상태 `REJECTED`(반려)로 변경
    - `current_approval_step` **그대로 유지**
    - `last_rejection_date` 현재 날짜 기입
- **결재선**
    - **0번째** 결재선에 '강제 반려' 사유(`rejected_reason`) 기록
    - 주의: 결재선이 없는 영수증에 실행 시 사유 없음, 메일 발송은 제출자만

### **결재 마감 일괄 반려**

**메서드**: `ReceiptRequestService.rejectReceipts`

- **영수증**
    - 상태 `REJECTED`(반려)로 변경
    - `current_approval_step` **그대로 유지**
    - `last_rejection_date` 현재 날짜 기입
- **결재선**
    - **0번째** 결재선에 반려 사유(`rejected_reason`) 기록
    - 주의: 결재선이 없는 영수증에 실행 시 사유 없음, 메일 발송은 제출자만

### **사용자 비활성화 반려 및 영수증 권한 변경**

**메서드**: `ReceiptRequestService.rejectAndRemoveApprover`

#### **케이스 1: 비활성화 사용자가 이미 승인한 경우**

해당 영수증 반려 후 재신청시(강제 신청 포함) 결재선 사용자 재확인 해서 상관 없음

- **영수증, 결재선**
    - 그대로 유지

#### **케이스 2 (통합): 비활성화 사용자가 아직 승인 전인 경우**

- **영수증**
    - 상태 `REJECTED`(반려)로 변경
    - `last_rejection_date` 현재 날짜 기입
    - `current_approval_step`은 남은 미승인 결재자 유무에 따라 결정 (있으면 다음 결재자 순번, 없으면 `null`)
- **결재선**
    - 비활성화된 사용자 제거
    - 남은 결재선의 순서(`step_order`) 재정렬
    - 남은 결재선이 있을 경우, 0번째에 반려 사유(`rejected_reason`) 기록
    - 주의: 결재선이 없는 영수증에 실행 시 사유 없음, 메일 발송은 제출자만