# 회원 가입 프로세스

<br>

## 🌱 흐름도

### 전체 흐름도

```mermaid
flowchart LR
    subgraph Stage1[1단계: 이메일 인증 및 임시가입]
        A[사용자 정보 입력] --> B[이메일 인증코드 발송 요청<br/>POST /email/send]
        B --> C[인증코드 생성 및 메일 발송]
        C --> D[사용자 인증코드 입력]
        D --> E{인증코드 검증 성공?}
        E -->|아니오| D
        E -->|예| F[필수 약관 동의]
        F --> G[임시가입 요청 제출<br/>POST /users/temp/join]
        G --> H{서버 검증<br/>이메일 중복, 인증, 약관}
        H -->|실패| G
        H -->|성공| I[임시 사용자 저장<br/>AuthTempUser]
    end
    
    subgraph Stage2[2단계: 관리자 승인 및 정식 가입]
        J[관리자 승인 대기<br/>POST /users/temp/:id/approve] --> K[정식 사용자 생성<br/>AuthUser]
        K --> L[가입 이벤트 발행<br/>Outbox/Kafka]
        L --> M[타 서비스 동기화<br/>HRM 등]
        M --> N[정식 로그인 가능]
    end
    
    I --> J
```

### 시퀀스 다이어그램 (인증/임시가입/승인)

#### 1단계: 이메일 인증

```mermaid
sequenceDiagram
    participant User as 사용자
    participant Frontend as Frontend(Vue)
    participant Auth as Auth 서비스
    participant ES as EmailService
    participant SMTP as SMTP Server

    User->>Frontend: 이메일 입력 및 인증 요청
    Frontend->>Auth: POST /email/send
    Auth->>ES: 인증코드 생성 및 발송
    ES->>SMTP: 메일 발송
    SMTP-->>ES: 발송 완료
    ES-->>Auth: 인증코드 저장 완료
    Auth-->>Frontend: 200 OK (코드 발송)

    User->>Frontend: 인증코드 입력
    Frontend->>Auth: POST /email/verify
    Auth->>Auth: 인증코드 검증
    alt 검증 성공
        Auth->>Auth: verified=true 저장
        Auth-->>Frontend: 200 OK (이메일 인증 성공)
    else 검증 실패
        Auth-->>Frontend: 400 Bad Request
    end
```

#### 2단계: 임시 가입

```mermaid
sequenceDiagram
    participant User as 사용자
    participant Frontend as Frontend(Vue)
    participant Auth as Auth 서비스
    participant DB as Database

    User->>Frontend: 약관 동의 후 가입 제출
    Frontend->>Auth: POST /users/temp/join
    
    Auth->>Auth: 이메일 중복 검사
    Auth->>Auth: 이메일 인증 상태 확인
    Auth->>Auth: 필수 약관 동의 확인
    
    alt 검증 성공
        Auth->>DB: AuthTempUser 저장
        Auth->>DB: TempUserAgreement 저장
        Auth-->>Frontend: 200 OK (임시가입 완료, 승인 대기)
    else 검증 실패
        Auth-->>Frontend: 400 Bad Request
    end
```

#### 3단계: 관리자 승인

```mermaid
sequenceDiagram
    participant Admin as 관리자
    participant Frontend as Frontend(Vue)
    participant Auth as Auth 서비스
    participant DB as Database
    participant Kafka as Kafka
    participant HRM as HRM 서비스

    Admin->>Frontend: 임시 사용자 승인 요청
    Frontend->>Auth: POST /users/temp/:id/approve
    
    Auth->>DB: AuthTempUser 조회
    Auth->>DB: AuthUser 생성
    Auth->>DB: AuthTempUser 삭제
    
    Auth->>Kafka: AuthUserJoinedEvent 발행
    Kafka->>HRM: 이벤트 전달
    HRM->>HRM: 사용자 동기화 처리
    
    Auth-->>Frontend: 200 OK (정식 전환 완료)
    Frontend-->>Admin: 승인 완료
```

### **엔드포인트 요약**

- **이메일 인증**
    - **POST** `/email/send`: 인증코드 발송
    - **POST** `/email/verify`: 인증코드 검증(성공 시 이메일 인증됨)
- **약관**
    - **GET** `/agreements`: 최신 약관 목록
- **임시가입/승인**
    - **GET** `/users/temp`: 임시 사용자 목록(관리자)
    - **POST** `/users/temp/join`: 임시 회원가입
    - **POST** `/users/temp/{id}/approve`: 임시 사용자 승인(정식 전환)
    - **DELETE** `/users/temp/{id}`: 임시 사용자 삭제

<br><br>

## **🌳 검증 규칙 핵심**

- **이메일 중복**: 정식/임시 사용자 모두 검사, 중복 시 거절
- **이메일 인증 필수**: `/email/verify` 성공 상태여야 임시가입 허용
- **필수 약관 동의**: 누락 시 거절
- **인증코드**: 6자리, 5분 만료. 만료/불일치 시 실패

### **메일 발송 개요**

---

- **목적**: 회원가입 이메일 인증, 비밀번호 찾기(임시 비밀번호 발급), 소셜 연동 알림
- **인증코드**: 6자리 숫자, 유효기간 5분, 검증 성공 시 DB에 verified=true

<br><br>