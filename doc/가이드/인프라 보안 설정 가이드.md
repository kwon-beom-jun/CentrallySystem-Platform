# 보안 설정 가이드

## 경로 변수 설명

이 문서에서 사용하는 경로 변수:
- `{app}` - 애플리케이션 루트 경로 (예: `/was/dummy_app`)
- `{도메인}` - 실제 도메인명 (예: `example.com`)

실제 적용 시 위 변수를 실제 경로/도메인으로 치환하여 사용하세요.

## 목차
1. [현재 적용된 보안 설정](#현재-적용된-보안-설정)
2. [추가 적용 권장 설정](#추가-적용-권장-설정)
3. [보안 점검 체크리스트](#보안-점검-체크리스트)

---

## 현재 적용된 보안 설정

### 1. Nginx Rate Limiting (DDoS 방어)

#### 설정 파일
- `/etc/nginx/conf.d/rate-limit.conf` - Rate limit zone 정의
- `/etc/nginx/sites-available/vue-app` - Rate limit 적용

#### 적용된 제한
| 제한 타입 | Zone | Rate | Burst | 설명 |
|---------|------|------|-------|------|
| 일반 페이지 | general_limit | 10r/s | 5 | 메인 페이지 등 |
| API | api_limit | 10r/s | 200 | API 요청 (조직도 고려) |
| 인증 API | api_limit | 10r/s | 5 | 로그인/인증 |
| 하루 제한 | daily_limit | 20r/m | 20 | 일일 요청 제한 |
| 동시 연결 | conn_limit | 10 | - | IP당 동시 연결 |
| 정적 파일 | static_limit | 100r/s | 200 | JS/CSS/이미지 |

#### 429 에러 페이지
- 경로: `{app}/dist/errors/429.html`
- Rate limit 초과 시 사용자 친화적 페이지 표시
- 자동 카운트다운 및 리다이렉트

#### 적용 방법
```bash
# Nginx 설정 테스트
sudo nginx -t

# Nginx 재시작 (zone 정의 변경 시)
sudo systemctl restart nginx

# Nginx 리로드 (설정 변경만)
sudo systemctl reload nginx
```

### 2. 파일 업로드 용량 제한

#### Nginx 설정
```nginx
# /etc/nginx/sites-available/vue-app
client_max_body_size 20m;
client_body_buffer_size 128k;
```

#### Spring Boot 설정
각 서비스별 `application.properties`:
```properties
# HRM, INFO, RECEIPT 서비스
spring.servlet.multipart.max-file-size=20MB
spring.servlet.multipart.max-request-size=20MB
file.upload.total.size=20
```

### 3. 파일 저장 구조 (웹 루트 외부)

#### 디렉토리 구조
```
{app}/
├── dist/              ← 웹 루트 (Nginx가 직접 제공)
│   ├── index.html
│   ├── assets/
│   └── errors/
└── upload/            ← 업로드 폴더 (백엔드만 접근 가능)
    ├── img/
    │   ├── hrm/profile/
    │   ├── info/
    │   └── receipt/
```

#### 보안 효과
- ✅ 업로드 파일 직접 URL 접근 차단
- ✅ 백엔드 컨트롤러를 통한 접근만 허용
- ✅ 권한 검증 후 파일 제공

### 4. Nginx 프록시 구조

```nginx
# 정적 파일 (직접 제공)
location / {
    root {app}/dist;
    try_files $uri $uri/ /index.html;
}

# API 요청 (백엔드 프록시)
location /api/ {
    proxy_pass http://127.0.0.1:7070/;
    # Rate limiting 적용
    limit_req zone=api_limit burst=200 nodelay;
}
```

**보안 효과:**
- ✅ `/upload/` 경로 직접 접근 불가
- ✅ 모든 파일 다운로드는 백엔드 컨트롤러 통과
- ✅ 권한 검증 가능

### 5. SSL/TLS 암호화

```nginx
# Let's Encrypt SSL 인증서
ssl_certificate /etc/letsencrypt/live/{도메인}/fullchain.pem;
ssl_certificate_key /etc/letsencrypt/live/{도메인}/privkey.pem;
include /etc/letsencrypt/options-ssl-nginx.conf;
ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

# HTTP → HTTPS 강제 리다이렉트
return 301 https://{도메인}$request_uri;
```

### 6. 파일명 안전화 (Path Traversal 방어)

```java
// FileNameUtils.java
public static String safeName(String original) {
    // 경로 구분자, 특수문자 제거
    String sanitized = ILLEGAL.matcher(original).replaceAll("_");
    // 타임스탬프 + UUID 추가
    String timestamp = LocalDateTime.now().format(TS);
    return timestamp + "_" + UUID.randomUUID() + "_" + sanitized;
}
```

**보안 효과:**
- ✅ Path Traversal 공격 차단 (`../../etc/passwd` 같은 경로)
- ✅ 파일명 중복 방지
- ✅ 특수문자/공백 제거

### 7. 프로필 이미지 압축 (트래픽 비용 절감)

```javascript
// UserInformation.vue
processImageFile(file, {
  minSizeMB: 0.05,      // 50KB 미만은 압축 안 함
  maxSizeMB: 0.15,      // 최대 150KB
  maxWidthOrHeight: 300 // 최대 300x300px
});
```

**효과:**
- 390KB → 20-30KB로 감소 (약 94% 절감)
- 조직도 100명 기준: 39MB → 2.5MB

### 8. 업로드 폴더 noexec 마운트 (파일 실행 차단)

#### 적용 상태
```bash
# 현재 마운트 확인
mount | grep {app}/upload
```

**출력 예시:**
```
/dev/nvme0n1p1 on {app}/upload type ext4 (rw,nosuid,nodev,noexec,relatime,discard,errors=remount-ro,commit=30)
```

#### 적용된 보안 옵션
- `noexec` - 파일 실행 차단 (직접 실행 불가)
- `nosuid` - setuid/setgid 비트 무시 (권한 상승 차단)
- `nodev` - 장치 파일 해석 차단

#### 보안 효과
- ✅ 업로드된 파일이 서버에서 실행되는 것 원천 차단
- ✅ 웹 서버 취약점으로 파일 실행 시도 차단
- ✅ 실수로 실행되는 경우 방지

#### 적용 방법 (재부팅 후에도 유지)
```bash
# /etc/fstab에 추가
sudo nano /etc/fstab
```

**파일 끝에 추가:**
```
{app}/upload  {app}/upload  none  bind,noexec,nosuid,nodev  0  0
```

```bash
# 적용
sudo mount -a

# 확인
mount | grep {app}/upload
```

---

## 추가 적용 권장 설정

### 1. 파일 실행 권한 제거 (추가 보안)

#### 목적
업로드된 파일이 서버에서 실행되는 것을 원천 차단

#### 공격 시나리오
```bash
# 공격자가 악성 스크립트 업로드 후
bash {app}/upload/info/malicious.sh  # 실행 시도
python {app}/upload/info/malware.py  # 실행 시도
```

#### 적용 방법

**현재 적용된 방법: Bind Mount (권장)**

별도 파티션 분리 없이 기존 디렉토리에 noexec 옵션을 적용하는 방법입니다.

##### 1단계: 현재 상태 확인
```bash
# 어떤 파일시스템에 속해있는지 확인
df -h {app}/upload

# 출력 예시:
# Filesystem      Size  Used Avail Use% Mounted on
# /dev/root        19G  4.7G   14G  26% /
```

##### 2단계: Bind Mount 적용 (임시)
```bash
# 1. Bind mount 생성
sudo mount --bind {app}/upload {app}/upload

# 2. noexec 옵션 적용
sudo mount -o remount,noexec,nosuid,nodev {app}/upload

# 3. 확인
mount | grep {app}/upload
```

**출력 예시:**
```
/dev/nvme0n1p1 on {app}/upload type ext4 (rw,nosuid,nodev,noexec,relatime,discard,errors=remount-ro,commit=30)
```

##### 3단계: 영구 적용 (/etc/fstab)
```bash
# /etc/fstab 편집
sudo nano /etc/fstab
```

**파일 끝에 추가:**
```
{app}/upload  {app}/upload  none  bind,noexec,nosuid,nodev  0  0
```

**저장 후 적용:**
```bash
# 마운트 테스트 (에러 확인)
sudo mount -a

# 확인
mount | grep {app}/upload
```

**참고: 별도 파티션 분리 (선택적, 더 안전하지만 복잡)**

별도 파티션으로 완전히 분리하는 방법도 가능하지만, bind mount로도 충분히 안전합니다.

#### 옵션 설명
| 옵션 | 설명 |
|-----|------|
| `noexec` | 실행 파일 실행 차단 (bash, python으로도 불가) |
| `nosuid` | setuid/setgid 비트 무시 (권한 상승 차단) |
| `nodev` | 장치 파일 해석 차단 |

#### 테스트
```bash
# 테스트 스크립트 생성
echo '#!/bin/bash' | sudo tee {app}/upload/test.sh
echo 'echo "test execution"' | sudo tee -a {app}/upload/test.sh
sudo chmod +x {app}/upload/test.sh

# 실행 시도 (차단되어야 함)
./test.sh                    # Permission denied ✅
bash {app}/upload/test.sh     # 실행됨 ⚠️ (인터프리터로 실행)
python3 {app}/upload/test.py  # 실행됨 ⚠️ (인터프리터로 실행)

# 테스트 파일 삭제
sudo rm {app}/upload/test.sh
```

**테스트 결과 설명:**
- `./test.sh` - 직접 실행 차단됨 ✅ (noexec 작동)
- `bash test.sh` - 인터프리터로 실행됨 ⚠️ (정상 동작)

**보안 효과:**
- ✅ 파일 자체 실행 차단 (가장 중요한 방어)
- ✅ 웹 서버 취약점으로 실행 시도 차단
- ⚠️ 인터프리터(bash, python)로 실행은 가능 (이미 서버 접근 시도 시점이므로 추가 보안 필요)

### 1. 파일 실행 권한 제거 (추가 보안)

#### 적용 방법

**Option 1: 파일 저장 시 권한 설정 (Java)**

```java
// InfoPostService.java, HrmUserService.java 등
try {
    file.transferTo(dest);
    
    // 실행 권한 제거 (추가 안전장치)
    dest.setReadable(true, false);    // 모두 읽기 가능
    dest.setWritable(true, true);     // 소유자만 쓰기 가능
    dest.setExecutable(false, false); // 실행 권한 제거
    
} catch (IllegalStateException | IOException e) {
    log.error("파일 업로드 실패: " + filename, e);
}
```

**Option 2: Cron 작업으로 일괄 처리**

```bash
# /etc/cron.daily/remove-exec-permissions
#!/bin/bash
find {app}/upload -type f -exec chmod 644 {} \;
```

```bash
# 실행 권한 부여
sudo chmod +x /etc/cron.daily/remove-exec-permissions
```

### 2. 다운로드 시 강제 다운로드 헤더 (선택)

현재는 이미지 직접 표시가 필요하므로 선택적 적용

```java
// 파일 다운로드 컨트롤러
return ResponseEntity.ok()
    .header(HttpHeaders.CONTENT_DISPOSITION, 
            "attachment; filename=\"" + originalName + "\"")
    .body(resource);
```

### 3. 바이러스 스캔 (선택)

#### ClamAV 설치 및 설정

```bash
# 1. ClamAV 설치
sudo apt update
sudo apt install clamav clamav-daemon

# 2. 바이러스 DB 업데이트
sudo freshclam

# 3. 서비스 시작
sudo systemctl start clamav-daemon
sudo systemctl enable clamav-daemon
```

#### Spring Boot 통합 (선택)

```java
// 업로드 시 바이러스 스캔
public void scanFile(File file) throws IOException {
    ProcessBuilder pb = new ProcessBuilder(
        "clamdscan", "--no-summary", file.getAbsolutePath()
    );
    Process process = pb.start();
    int exitCode = process.waitFor();
    
    if (exitCode != 0) {
        file.delete();
        throw new RuntimeException("바이러스 감염 파일 차단");
    }
}
```

---

## 보안 점검 체크리스트

### Nginx
- [ ] Rate limiting 설정 확인
  ```bash
  sudo nginx -T | grep -A 5 "limit_req_zone"
  ```
- [ ] SSL 인증서 만료일 확인
  ```bash
  sudo certbot certificates
  ```
- [ ] client_max_body_size 설정 확인

### 파일 시스템
- [ ] 업로드 폴더 noexec 마운트 확인
  ```bash
  mount | grep {app}/upload
  # 출력에 noexec,nosuid,nodev 포함되어야 함
  ```
- [ ] /etc/fstab 영구 설정 확인
  ```bash
  grep {app}/upload /etc/fstab
  ```
- [ ] 파일 권한 확인
  ```bash
  ls -la {app}/upload/img/hrm/profile/
  ```
- [ ] 웹 루트와 업로드 폴더 분리 확인

### Spring Boot
- [ ] multipart 용량 제한 확인
  ```bash
  grep "max-file-size" centrally-system-config/src/main/resources/config/*.properties
  ```
- [ ] 파일명 안전화 적용 확인

### 모니터링
- [ ] Nginx 에러 로그 확인
  ```bash
  sudo tail -100 /var/log/nginx/error.log
  ```
- [ ] Rate limiting 로그 확인
  ```bash
  sudo grep "limiting requests" /var/log/nginx/error.log
  ```

### 정기 점검 (월 1회)
- [ ] SSL 인증서 갱신 (자동)
  ```bash
  sudo certbot renew --dry-run
  ```
- [ ] 바이러스 DB 업데이트 (ClamAV 사용 시)
  ```bash
  sudo freshclam
  ```
- [ ] 업로드 파일 권한 점검
  ```bash
  find {app}/upload -type f -perm -111
  ```

---

## 참고: 대형 서비스 보안 전략

### 네이버, 구글, 드롭박스 등

1. **noexec 마운트** - 업로드 폴더 실행 차단
2. **웹 루트 외부 저장** - 직접 URL 접근 불가
3. **바이러스 스캔** - ClamAV, VirusTotal API 등
4. **Content-Disposition** - 강제 다운로드
5. **CDN 분리** - 업로드 파일은 별도 도메인 (예: files.example.com)
6. **파일 타입 검증** - Magic Number 검사
7. **용량 제한** - 사용자당 저장 용량 제한
8. **암호화** - 저장 시 암호화 (민감한 파일)

---

## 긴급 대응

### Rate Limit 공격 발생 시

```bash
# 특정 IP 차단
sudo iptables -A INPUT -s 악의적IP -j DROP

# Nginx 재시작으로 공유 메모리 초기화
sudo systemctl restart nginx
```

### 악성 파일 업로드 발견 시

```bash
# 1. 해당 파일 즉시 삭제
sudo rm -f {app}/upload/suspicious_file

# 2. DB에서 레코드 삭제 (필요 시)
# SQL로 파일 URL 검색 후 삭제

# 3. 업로드 폴더 전체 스캔
sudo clamscan -r {app}/upload
```

---

## 관련 문서
- [AWS 배포 가이드.md](./AWS%20배포%20가이드.md)
- [JENKINS 설정 가이드.md](./JENKINS%20설정%20가이드.md)

